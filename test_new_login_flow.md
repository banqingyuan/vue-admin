# 新登录流程测试指南

## 修改总结

### ✅ 已完成的修改

1. **主登录页面改造**
   - 将 `login.vue` 改为直接使用手机号+验证码登录
   - 使用 `AuthenticationCodeLogin` 组件替代原有的用户名密码登录
   - 验证码长度改为 4 位

2. **移除不需要的功能**
   - 移除扫码登录路由 (`/auth/qrcode-login`)
   - 移除注册路由 (`/auth/register`)
   - 移除 code-login 独立路由（现在直接集成到主登录页面）
   - 隐藏返回按钮（通过 `showBackButton: false`）

3. **保留的功能**
   - 忘记密码功能 (`/auth/forget-password`)
   - 手机号格式验证
   - 4位验证码输入
   - 发送验证码功能（60秒倒计时）

### 🎯 新的登录流程

1. **访问登录页面**: `http://localhost:5173/login`
2. **输入手机号**: 支持中国大陆11位手机号
3. **发送验证码**: 点击验证码输入框右侧的"发送验证码"按钮
4. **输入4位验证码**: 在PIN输入框中输入收到的验证码
5. **登录**: 点击登录按钮完成登录

### 📋 UI 特性

- **简洁界面**: 只有手机号和验证码两个输入框
- **PIN 输入**: 4位验证码使用专门的PIN输入组件
- **发送按钮**: 集成在验证码输入框右侧，带倒计时功能
- **无多余选项**: 没有扫码登录、三方登录、注册等按钮
- **保持风格**: 完全保留 vben-admin 的原有UI风格

## 测试步骤

### 1. 启动服务

```bash
# 启动后端
cd /Users/qingyuan/qingyuaner/mahjong-backend
./admin_backend

# 启动前端
cd /Users/qingyuan/qingyuaner/vue-vben-admin/apps/web-antd
pnpm dev
```

### 2. 准备测试数据

```sql
-- 插入测试管理员用户
INSERT INTO admin_users (phone, username, role, status, created_at, updated_at)
VALUES ('13800138000', 'admin', 'admin', 'active', NOW(), NOW());
```

### 3. 测试登录流程

1. **访问登录页面**
   - 打开 http://localhost:5173/login
   - 确认页面只显示手机号和验证码输入框
   - 确认没有扫码登录、注册等其他选项

2. **测试手机号输入**
   - 输入无效手机号，检查验证提示
   - 输入有效手机号: `13800138000`

3. **测试发送验证码**
   - 点击验证码输入框右侧的"发送验证码"按钮
   - 确认按钮变为倒计时状态
   - 检查后端日志确认验证码发送成功

4. **测试验证码输入**
   - 在4位PIN输入框中输入验证码: `1234`（如果配置了白名单）
   - 确认输入框正确显示4位数字

5. **测试登录**
   - 点击"登录"按钮
   - 确认成功跳转到仪表板
   - 检查用户信息是否正确显示

### 4. 验证功能完整性

- ✅ 手机号格式验证
- ✅ 验证码发送功能
- ✅ 60秒倒计时
- ✅ 4位验证码输入
- ✅ 登录成功跳转
- ✅ JWT token 正确设置
- ✅ 用户信息正确显示
- ✅ 无扫码登录选项
- ✅ 无三方登录选项
- ✅ 无注册选项
- ✅ 无返回按钮

## 可能的问题

### 1. 验证码发送失败

- 检查后端服务是否正常运行
- 检查手机号是否在白名单中
- 查看后端日志了解具体错误

### 2. 登录失败

- 确认验证码是否正确（白名单用户使用 `1234`）
- 检查管理员用户是否存在且状态为 `active`
- 查看网络请求是否正常

### 3. UI 显示问题

- 清除浏览器缓存
- 检查前端控制台是否有错误
- 确认所有依赖包已正确安装

## API 接口

| 接口         | 方法 | 路径                        | 说明              |
| ------------ | ---- | --------------------------- | ----------------- |
| 发送验证码   | POST | `/api/admin/auth/send-code` | 发送短信验证码    |
| 验证码登录   | POST | `/api/admin/auth/login`     | 手机号+验证码登录 |
| 获取用户信息 | GET  | `/api/admin/auth/me`        | 获取当前用户信息  |
| 退出登录     | POST | `/api/admin/auth/logout`    | 退出登录          |

## 成功标准

✅ 登录页面只显示手机号和验证码输入框✅ 没有扫码登录、三方登录、注册等选项✅ 验证码为4位PIN输入✅ 发送验证码功能正常工作✅ 登录流程完整可用✅ UI风格保持一致
